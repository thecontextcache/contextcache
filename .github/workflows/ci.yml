name: CI

on:
  push:
    branches: ["main", "dev"]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  exposure-guard:
    name: Security — proprietary exposure guard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run public exposure guard
        run: ./scripts/check_public_exposure.sh

      - name: Run brain readiness gate
        run: ./scripts/check_brain_graph_readiness.sh

      - name: Run UI quality gate
        run: ./scripts/check_ui_quality_gates.sh

  security-scan:
    name: Security — static/dependency scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python security tools
        run: python -m pip install --upgrade pip bandit pip-audit

      - name: Bandit static scan
        run: bandit -r api/app -x api/tests -q

      - name: Python dependency audit
        run: pip-audit -r api/requirements.lock

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install web dependencies
        working-directory: web
        run: npm install

      - name: NPM audit (critical)
        working-directory: web
        run: npm audit --omit=dev --audit-level=critical

  # ── API tests ────────────────────────────────────────────────────────────────
  api-tests:
    name: API — tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare .env from example
        run: cp .env.example .env

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: buildx-api-${{ hashFiles('api/pyproject.toml', 'api/uv.lock', 'api/Dockerfile') }}
          restore-keys: buildx-api-

      - name: Build API images
        run: |
          docker compose build api api-test
        env:
          BUILDX_CACHE_FROM: type=local,src=/tmp/.buildx-cache
          BUILDX_CACHE_TO: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Start test database
        run: docker compose --profile test up -d db-test

      - name: Wait for db-test to be healthy
        run: |
          for i in $(seq 1 20); do
            STATUS=$(docker compose --profile test ps db-test --format '{{.Health}}' 2>/dev/null || echo "unknown")
            echo "db-test health: $STATUS (attempt $i)"
            [ "$STATUS" = "healthy" ] && exit 0
            sleep 3
          done
          echo "db-test did not become healthy in time"
          docker compose --profile test logs db-test
          exit 1

      - name: Run API tests
        run: docker compose --profile test run --rm api-test
        env:
          APP_ENV: test

      - name: Lint API (flake8)
        run: docker compose --profile test run --rm api-test sh -c "uv run flake8 app tests"

      - name: Check schema drift (alembic check)
        run: |
          docker compose --profile test run --rm \
            -e DATABASE_URL=postgresql+asyncpg://contextcache:contextcache@db-test:5432/contextcache_test \
            -e APP_ENV=test \
            api-test sh -c "uv run python -m app.migrate && uv run alembic check"

      - name: Tear down
        if: always()
        run: docker compose --profile test down -v

  # ── Web build ────────────────────────────────────────────────────────────────
  web-build:
    name: Web — Next.js build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        working-directory: web
        run: npm install

      - name: Build Next.js app
        working-directory: web
        run: npm run build
        env:
          NEXT_PUBLIC_API_BASE_URL: ""
          NEXT_PUBLIC_DOCS_URL: ""

  a11y-lint:
    name: Web — a11y lint & contrast
    runs-on: ubuntu-latest
    needs: [web-build]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        working-directory: web
        run: npm install

      - name: Run lint
        working-directory: web
        run: npm run lint

      - name: Run token contrast checks
        working-directory: web
        run: npm run test:tokens:contrast

  a11y-smoke:
    name: Web — Axe smoke
    runs-on: ubuntu-latest
    needs: [web-build]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        working-directory: web
        run: npm install

      - name: Install Playwright Chromium
        working-directory: web
        run: npx playwright install --with-deps chromium

      - name: Build app
        working-directory: web
        run: npm run build
        env:
          NEXT_PUBLIC_API_BASE_URL: ""
          NEXT_PUBLIC_DOCS_URL: ""

      - name: Start app
        working-directory: web
        run: |
          npm run start > /tmp/next-a11y.log 2>&1 &
          echo $! > /tmp/next-a11y.pid

      - name: Wait for app
        run: |
          for i in $(seq 1 30); do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000/auth || echo "000")
            echo "wait attempt $i status $CODE"
            [ "$CODE" = "200" ] && exit 0
            sleep 2
          done
          cat /tmp/next-a11y.log
          exit 1

      - name: Run axe smoke suite
        working-directory: web
        env:
          A11Y_BASE_URL: "http://127.0.0.1:3000"
        run: npm run test:a11y:smoke

      - name: Stop app
        if: always()
        run: |
          if [ -f /tmp/next-a11y.pid ]; then
            kill "$(cat /tmp/next-a11y.pid)" || true
          fi
          cat /tmp/next-a11y.log || true

  brain-perf:
    name: Web — Brain synthetic perf check
    runs-on: ubuntu-latest
    needs: [web-build]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        working-directory: web
        run: npm install

      - name: Install Playwright Chromium
        working-directory: web
        run: npx playwright install --with-deps chromium

      - name: Build app
        working-directory: web
        run: npm run build
        env:
          NEXT_PUBLIC_API_BASE_URL: ""
          NEXT_PUBLIC_DOCS_URL: ""
          NEXT_PUBLIC_BRAIN_RENDERER: "webgl"

      - name: Start app
        working-directory: web
        run: |
          npm run start > /tmp/next-web.log 2>&1 &
          echo $! > /tmp/next-web.pid

      - name: Wait for app
        run: |
          for i in $(seq 1 30); do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000/auth || echo "000")
            echo "wait attempt $i status $CODE"
            [ "$CODE" = "200" ] && exit 0
            sleep 2
          done
          cat /tmp/next-web.log
          exit 1

      - name: Run brain perf check
        working-directory: web
        env:
          NEXT_PUBLIC_BRAIN_RENDERER: "webgl"
          BRAIN_PERF_BASE_URL: "http://127.0.0.1:3000"
          BRAIN_PERF_NODES: "10000"
          BRAIN_PERF_EDGES: "30000"
          BRAIN_MIN_FPS: "15"
          BRAIN_MAX_P95_MS: "80"
          BRAIN_MAX_LOAD_MS: "12000"
        run: npm run perf:brain

      - name: Stop app
        if: always()
        run: |
          if [ -f /tmp/next-web.pid ]; then
            kill "$(cat /tmp/next-web.pid)" || true
          fi
          cat /tmp/next-web.log || true

  cli-build:
    name: CLI/SDK — package build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Build SDK package
        working-directory: cli
        run: |
          python -m pip install --upgrade pip build
          python -m build

  # ── Docker smoke test ────────────────────────────────────────────────────────
  docker-smoke:
    name: Docker — compose build
    runs-on: ubuntu-latest
    needs: [exposure-guard, security-scan, api-tests, web-build, a11y-lint, a11y-smoke, brain-perf, cli-build]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare .env from example
        run: cp .env.example .env

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build all runtime images
        run: docker compose build api web

      - name: Start services
        run: docker compose up -d db api

      - name: Wait for API to be healthy
        run: |
          for i in $(seq 1 30); do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health || echo "000")
            echo "Health check attempt $i: HTTP $CODE"
            [ "$CODE" = "200" ] && exit 0
            sleep 3
          done
          echo "API did not become healthy"
          docker compose logs api
          exit 1

      - name: Verify /health
        run: |
          BODY=$(curl -sf http://localhost:8000/health)
          echo "Response: $BODY"
          echo "$BODY" | grep -q '"ok"'

      - name: Tear down
        if: always()
        run: docker compose down -v
